;define(function(require){'use strict';var $=require('jquery'),f=require('underscore'),d=require('backbone'),a=require('core/app'),u=require('core/lib/hooks'),g=require('root/config'),P=require('core/lib/encryption/sha256'),U=require('core/lib/encryption/token'),n=require('core/app-utils');require('core/lib/encryption/jsencrypt');require('localstorage');var k=d.Model.extend({localStorage:new d.LocalStorage('Authentication-'+g.app_slug),defaults:{user_login:'',secret:'',public_key:'',is_authenticated:!1,permissions:{},info:{},user_device_id:''}});var e=new k({id:'Authentication-'+g.app_slug});e.fetch();var b=U.getWebServiceUrlToken('authentication')+'/authentication/',t={};var o=function(){var r='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890-=!@#$%^&*()_+:<>{}[]'.split(''),t='';for(var e=0;e<50;e++){t+=r[Math.floor(Math.random()*r.length)]};return t},m=function(){var r='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890'.split(''),t='';for(var e=0;e<10;e++){t+=r[Math.floor(Math.random()*r.length)]};return t};if(!e.get('user_device_id')){e.set('user_device_id',m());e.save()};n.log('User device ID :',e.get('user_device_id'));var x=function(){var r=o();e.set('secret',r);e.save()},c=function(e,r){if(r!==undefined){e=e+'|'+r};return P(e)},h=function(e,r,t){return c(e,r)===t},v=function(){return Math.floor(Date.now()/1000)},p=function(e,r){var t='';if(e.length){f.each(e,function(e){t+=e});t=c(t,r)};return t},I=function(e,r,t){var n=[];f.each(e,function(e){if(r.hasOwnProperty(e)){n.push(r[e])}});return p(n,t)},i=function(r,t,n,a,u,s){t=t===undefined?'wpak-app':t;s=s===undefined||s===!0;var g=v(),i={user:t,timestamp:g};if(s){i.auth_action=r};var c='';if(n===undefined||n===!1){c=o();i.control_key=c}else{c=e.get('secret')};var l=[r,t,g];if(a!==undefined&&u!==undefined){f.each(a,function(e){if(u.hasOwnProperty(e)){l.push(u[e]);if(s){i[e]=u[e]}}})};i.control=p(l,c);return i},l=function(e,r,t){e=u.applyFilters('web-service-params',e,['authentication']);var s={timeout:40000,data:e};s=u.applyFilters('ajax-args',s,['authentication']);s.url=g.wp_ws_url+b;s.type='GET';s.dataType='json';s.success=r;s.error=function(e,r,s){var i='ajax-failed';i+=(':'+n.getAjaxErrorType(e,r,s));t(i,{jqXHR:e,textStatus:r,errorThrown:s})};n.log('Sending authentication query',(e.hasOwnProperty('auth_action')?'"'+e.auth_action+'"':''),(e.hasOwnProperty('user')?'for user '+e.user:''));$.ajax(s)},y=function(r,t,s){var o=i('get_public_key',r,!1),a=function(i){if(i.hasOwnProperty('result')&&i.result.hasOwnProperty('status')){if(i.result.status==1){if(i.public_key&&i.public_key.length&&i.control){if(h(i.public_key+r,o.control_key,i.control)){e.set('public_key',i.public_key);e.save();n.log('Public key retrieved successfully');t(i.public_key)}else{s('wrong-hmac')}}else if(i.hasOwnProperty('auth_error')){s(i.auth_error)}else{s('no-auth-error')}}else{s('web-service-error',i.result.message)}}else{s('no-result')}},u=function(e){s(e)};l(o,a,u)},w=function(r,s,u,a){var g=e.get('public_key');if(g.length){var c=o();e.set('secret',c);var f=new JSEncrypt();f.setPublicKey(g);var w={user:r,pass:s,secret:c};var v=f.encrypt(JSON.stringify(w)),y=i('connect_user',r,!0,['encrypted','device_id'],{encrypted:v,device_id:e.get('user_device_id')});var p=function(s){if(s.hasOwnProperty('result')&&s.result.hasOwnProperty('status')&&s.result.hasOwnProperty('message')){if(s.result.status==1){if(s.hasOwnProperty('authenticated')){if(s.authenticated===1){if(s.hasOwnProperty('permissions')&&s.hasOwnProperty('info')){if(h('authenticated'+r,c,s.control)){e.set('user_login',r);e.set('secret',c);e.set('is_authenticated',!0);e.set('permissions',s.permissions);e.set('info',s.info);e.save();n.log('User "'+r+'" logged in successfully',t.getCurrentUser());u({user:r,permissions:s.permissions,info:s.info})}else{a('wrong-hmac')}}else{a('no-permissions')}}else if(s.hasOwnProperty('auth_error')){a(s.auth_error)}else{a('no-auth-error')}}else{a('wrong-auth-data')}}else{a('web-service-error',s.result.message)}}else{a('wrong-result-data')}},d=function(e){a(e)};l(y,p,d)}else{a('no-public-key')}};t.getActionAuthData=function(r,t,n){var o=null,u=e.get('is_authenticated');if(u){var s=e.get('user_login'),a=e.get('secret');if(s&&a){o=i(r,s,!0,t,n,!1)}};return o};t.getCurrentUser=function(r){var t=null,n=e.get('is_authenticated');if(n){t={login:e.get('user_login'),permissions:e.get('permissions'),info:e.get('info')}};if(r!==undefined&&t&&t.hasOwnProperty(r)){t=t[r]};return t};t.getUserDeviceId=function(){return e.get('user_device_id')};t.userIsLoggedIn=function(){return e.get('is_authenticated')};t.currentUserCan=function(r){var n=!1;if(e.get('is_authenticated')){var s=e.get('permissions');if(s.hasOwnProperty('capabilities')){n=(s.capabilities.indexOf(r)!==-1)};n=u.applyFilters('current-user-can',n,[r,e.get('permissions'),t.getCurrentUser()])};return n};t.currentUserRoleIs=function(r){var n=!1;if(e.get('is_authenticated')){var s=e.get('permissions');if(s.hasOwnProperty('roles')){n=(s.roles.indexOf(r)!==-1)};n=u.applyFilters('current-user-role',n,[r,e.get('permissions'),t.getCurrentUser()])};return n};t.checkUserAuthenticationFromRemote=function(r,s){var v=function(e){var s=t.getCurrentUser();n.log('User authentication remote check ok : user "'+s.login+'" connected',s);if(r!==undefined){r(e)}},a=function(e){var r='';switch(e){case'user-connection-expired':r+='user connection expired : user logged out';break;default:r+='user not connected ('+e+')';break};n.log('User authentication remote check : '+r);if(s!==undefined){s(e)}},y=e.get('is_authenticated');if(y){var h=e.get('public_key'),u=o(),p=c(h,u),d=i('check_user_auth',e.get('user_login'),!0,['hash','hasher','device_id'],{hash:p,hasher:u,device_id:e.get('user_device_id')});var f=function(r){if(r.hasOwnProperty('result')&&r.result.hasOwnProperty('status')&&r.result.hasOwnProperty('message')){if(r.result.status==1){if(r.hasOwnProperty('user_auth_ok')){if(r.user_auth_ok===1){e.set('permissions',r.permissions);e.set('info',r.info);e.save();v(t.getCurrentUser())}else if(r.hasOwnProperty('auth_error')){switch(r.auth_error){case'user-connection-expired':t.logUserOut(2);break;case'wrong-permissions':t.logUserOut(4);break;default:t.logUserOut(3);break};a(r.auth_error)}else{a('no-auth-error')}}else{a('wrong-answer-format')}}else{a('web-service-error : '+r.result.message)}}else{a('wrong-result-data')}},g=function(e){a(e)};l(d,f,g)}else{a('no-user-logged-in')}};t.logUserIn=function(e,r,t,n){y(e,function(s){w(e,r,function(e){e.type='authentication-info';a.triggerInfo('auth:user-login',e,t)},function(e,r){var t={type:'authentication-error',where:'authentication.logUserIn:sendAuthData'};if(r!==undefined){t.message=r};a.triggerError('auth:'+e,t,n)})},function(e,r){var t={type:'authentication-error',where:'authentication.logUserIn:getPublicKey'};if(r!==undefined){t.message=r};a.triggerError('auth:'+e,t,n)})};t.logUserOut=function(r){if(!e.get('is_authenticated')){return};r=(r===undefined)?1:r;var t='';switch(r){case 1:t='normal';break;case 2:t='user-connection-expired';break;case 3:t='user-not-authenticated';break;case 4:t='user-wrong-permissions';break;default:t='unknown';break};var i={type:'authentication-info',user:e.get('user_login'),permissions:e.get('permissions'),info:e.get('info'),logout_type:t};var s=e.get('user_login');e.set('user_login','');e.set('public_key','');e.set('secret','');e.set('is_authenticated',!1);e.set('permissions',{});e.set('info',{});e.save();a.triggerInfo('auth:user-logout',i);n.log('User "'+s+'" logged out')};var s='User authentication : ';if(e.get('is_authenticated')){s+=('user "'+e.get('user_login')+'" logged in');n.log(s,t.getCurrentUser())}else{s+='no user logged in';n.log(s)};return t});